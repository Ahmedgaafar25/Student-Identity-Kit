<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Identity Kit Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Importing Fonts -->
    <style>
        /* Added weight 900 to Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Courier+Prime:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Great+Vibes&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --theme-color: #1e3a8a;
            --theme-color-light: #2563eb;
        }

        body {
            background-color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #1e293b;
        }

        /* Layout */
        .main-container {
            display: flex;
            flex-direction: column-reverse; /* Controls on bottom for mobile */
            gap: 40px;
            width: 100%;
            max-width: 1200px;
            align-items: center;
        }

        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 60px;
            }
        }

        /* --- CONTROLS SECTION --- */
        .controls-wrapper {
            width: 100%;
            max-width: 380px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: sticky;
            top: 40px; 
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .controls-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .controls-card h2 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #0f172a;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            color: #94a3b8;
            margin: 15px 0 10px 0;
        }

        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; font-family: inherit; transition: border-color 0.2s; background: #fff; }
        .form-control:focus { border-color: var(--theme-color); box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1); }
        input[type="color"] { height: 40px; padding: 2px; cursor: pointer; }
        input[type="file"] { font-size: 11px; padding: 8px; }
        
        .row { display: flex; gap: 12px; }
        .row .form-group { flex: 1; }

        /* Button Styles */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; font-family: 'Inter', sans-serif; margin-bottom: 10px;
        }
        .btn-primary { background-color: #0f172a; color: white; }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-secondary { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background-color: #e2e8f0; }

        .btn-download { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .btn-download:hover { box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.3); transform: translateY(-1px); }

        .btn-generate { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; margin-top: 5px; }
        .btn-generate:hover { box-shadow: 0 6px 8px -1px rgba(139, 92, 246, 0.3); transform: translateY(-1px); }

        .btn-sm { padding: 8px 16px; width: auto; font-size: 12px; margin: 0 auto; display: inline-flex; }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 14px;
        }
        
        .file-input-wrapper label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border: 1px dashed #cbd5e1;
            border-radius: 6px;
            background: #f8fafc;
            color: #64748b;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-input-wrapper label:hover { border-color: var(--theme-color); color: var(--theme-color); background: #f0f9ff; }
        .file-input-wrapper input { display: none; }

        .ai-options {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }

        /* --- PREVIEW SECTION --- */
        .preview-column {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 20px; 
            width: 100%;
            padding-top: 40px;
        }

        .view-selector-container {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }

        .preview-item {
            display: none; /* Hidden by default, JS toggles this */
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            padding-bottom: 30px;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .preview-item.active {
            display: flex;
        }

        .preview-header {
            font-size: 14px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* === 1. ID CARD STYLES === */
        .id-card-wrapper {
            perspective: 1000px;
        }

        .id-card {
            width: 347px; /* Increased width by 10px */
            height: 212.5px; 
            background: #fff; 
            border-radius: 14px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05), 0 4px 8px rgba(0,0,0,0.05), 0 20px 40px rgba(0,0,0,0.1);
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            transform-style: preserve-3d; 
            user-select: none;
            transition: transform 0.6s;
        }
        
        .security-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.08; background-image: repeating-radial-gradient(circle at 0 0, transparent 0, #000 1px, transparent 2px, transparent 10px), repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 2px, transparent 15px); z-index: 0; pointer-events: none; }
        .gloss-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(125deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 30%, rgba(255,255,255,0.2) 35%, rgba(255,255,255,0.0) 45%, rgba(255,255,255,0) 100%); z-index: 20; pointer-events: none; }
        
        .header-bg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 85px; 
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--theme-color-light) 100%); 
            z-index: 1; 
            clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); 
        }
        
        .card-content { position: relative; z-index: 5; padding: 16px; display: flex; flex-direction: row; height: 100%; gap: 16px; }
        
        .photo-section { display: flex; flex-direction: column; align-items: center; margin-top: 10px; width: 90px; flex-shrink: 0; }
        .photo-frame { width: 85px; height: 105px; background-color: #f8fafc; border: 3px solid #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; z-index: 2; }
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        .photo-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #e2e8f0; color: #94a3b8; }
        .student-role { margin-top: 10px; background-color: var(--theme-color); color: white; padding: 4px 0; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; text-align: center; width: 100%; box-shadow: 0 2px 2px rgba(0,0,0,0.1); letter-spacing: 0.5px; }

        .details-section { flex: 1; display: flex; flex-direction: column; position: relative; }
        .header-row { 
            display: flex; 
            justify-content: flex-end; /* Align group to right */
            align-items: center; 
            gap: 8px; /* Slightly reduced gap */
            margin-bottom: 25px; 
            position: relative; 
            z-index: 10; 
            padding-right: 65px; /* Increased padding significantly to absolutely ensure no cutoff */
        }
        .university-text { 
            flex: 1; 
            overflow: hidden; 
            text-align: right; 
            min-width: 0; /* CRITICAL FIX: Allows text container to shrink below content width so it doesn't push logo out */
        }
        .university-name { 
            font-size: 12px; /* Reduced slightly to fit better */
            font-weight: 900; 
            color: white; 
            text-transform: uppercase; 
            line-height: 1.1; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            letter-spacing: 0.2px; 
            margin-bottom: 2px; 
            white-space: nowrap; 
        }
        .university-sub { font-size: 8px; color: rgba(255,255,255,0.85); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .logo-slot { 
            width: 44px; 
            height: 44px; 
            background: rgba(255,255,255,0.95); 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            border: 2px solid rgba(255,255,255,0.3); 
            flex-shrink: 0; 
            margin-top: 2px; /* Decreased by 8px */
        }
        .logo-slot img { width: 80%; height: 80%; object-fit: contain; }

        .smart-chip { width: 36px; height: 26px; background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); border-radius: 5px; margin-bottom: 8px; position: relative; overflow: hidden; box-shadow: inset 0 0 4px rgba(0,0,0,0.2); border: 1px solid #a16207; }
        .chip-lines { position: absolute; width: 100%; height: 100%; background: transparent; border: 1px solid rgba(0,0,0,0.1); border-radius: 4px; top: 0; left: 0; }
        .chip-inner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; border: 1px solid rgba(0,0,0,0.3); border-radius: 3px; }
        
        .contactless { position: absolute; top: 68px; right: 4px; opacity: 0.6; color: #1e293b; font-size: 14px; }
        
        .info-group { margin-bottom: 5px; }
        .label { font-size: 7px; color: #64748b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 1px; }
        .value { font-size: 11px; color: #0f172a; font-weight: 700; }
        .value-large { font-size: 15px; color: #0f172a; font-weight: 700; text-transform: uppercase; letter-spacing: -0.3px; }
        
        .id-number-group { 
            margin-top: auto; 
            padding-right: 75px; /* Increased padding further to accommodate hologram position */
        }
        .id-number { font-family: 'Share Tech Mono', monospace; font-size: 14px; letter-spacing: 1.5px; color: #334155; font-weight: bold; }
        
        .hologram { 
            position: absolute; 
            bottom: 15px; 
            right: 55px;   /* Moved further left (increased right margin) */
            width: 36px; 
            height: 36px; 
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1); 
            border-radius: 50%; 
            z-index: 10; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.8); 
        }
        .hologram::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.9) 50%, transparent 60%); animation: holo-flash 3s infinite linear; }
        @keyframes holo-flash { 0% { transform: translateY(100%) rotate(45deg); } 20% { transform: translateY(-100%) rotate(45deg); } 100% { transform: translateY(-100%) rotate(45deg); } }

        /* === 2. RECEIPT STYLES === */
        .receipt {
            background: #fff; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); font-family: 'Courier Prime', monospace; font-size: 11px; color: #1e293b; position: relative; border-radius: 2px; overflow: hidden; flex-shrink: 0;
            /* removed margin bottom as wrapper handles it */
        }
        .receipt::before { content: ''; position: absolute; top: -5px; left: 0; width: 100%; height: 10px; background: radial-gradient(circle, transparent, transparent 50%, #fff 50%, #fff 100%) -7px -8px / 16px 16px repeat-x; transform: rotate(180deg); }
        .receipt::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 10px; background: radial-gradient(circle, transparent, transparent 50%, #fff 50%, #fff 100%) -7px -2px / 16px 16px repeat-x; }

        .receipt-header-section { background: #f8fafc; padding: 30px 20px 15px 20px; text-align: center; border-bottom: 2px dashed #e2e8f0; }
        .receipt-logo { width: 40px; height: 40px; margin: 0 auto 10px auto; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #e2e8f0; }
        .receipt-logo img { width: 70%; height: 70%; object-fit: contain; }
        .r-title { font-family: 'Inter', sans-serif; font-weight: 900; font-size: 14px; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; } /* Made bolder */
        .r-subtitle { font-family: 'Inter', sans-serif; font-size: 9px; color: #64748b; text-transform: uppercase; }
        
        .receipt-body { padding: 20px; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .r-row.meta { color: #64748b; font-size: 10px; margin-bottom: 12px; }
        .r-row.strong { font-weight: 700; }
        .r-divider { border-top: 1px dashed #cbd5e1; margin: 15px 0; }
        
        .r-table { width: 100%; margin-bottom: 5px; border-collapse: collapse; }
        .r-table td { padding: 4px 0; vertical-align: top; }
        .r-table td.item { padding-right: 10px; }
        .r-table td.amt { text-align: right; white-space: nowrap; }
        
        .r-total { background: #f1f5f9; padding: 12px; border-radius: 6px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .r-total-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 700; font-family: 'Inter', sans-serif; }
        
        .receipt-footer { text-align: center; padding: 0 20px 30px 20px; }
        .barcode-box { text-align: center; margin-bottom: 10px; opacity: 0.8; }
        .paid-stamp { position: absolute; top: 50%; right: 30px; transform: rotate(-15deg); border: 3px solid #16a34a; color: #16a34a; font-size: 24px; font-weight: 800; padding: 5px 15px; border-radius: 8px; opacity: 0.2; pointer-events: none; text-transform: uppercase; font-family: 'Inter', sans-serif; z-index: 5; mix-blend-mode: multiply; }

        /* === 3. CONFIRMATION LETTER STYLES === */
        .letter-container {
            width: 500px; 
            min-height: 600px;
            background: #ffffff; 
            padding: 50px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.08); 
            position: relative; 
            font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; 
            color: #333; 
            font-size: 11px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
        }
        
        .letter-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; opacity: 0.03; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 0; }
        .letter-watermark i { font-size: 200px; color: #000; }
        
        .letter-head { border-bottom: 2px solid var(--theme-color); padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px; position: relative; z-index: 1; }
        .letter-logo { width: 50px; height: 50px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        .letter-logo img { width: 100%; height: 100%; object-fit: contain; }
        .letter-uni-info h1 { font-family: 'Inter', sans-serif; font-size: 18px; color: var(--theme-color); text-transform: uppercase; margin-bottom: 4px; font-weight: 900; } /* Made bolder */
        .letter-uni-info p { font-family: 'Inter', sans-serif; font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px; }
        
        .letter-meta { text-align: right; margin-bottom: 30px; font-style: italic; color: #64748b; font-size: 10px; }
        .letter-recipient { margin-bottom: 25px; font-weight: 700; font-size: 12px; }
        
        .letter-body { line-height: 2; margin-bottom: 30px; text-align: justify; z-index: 1; position: relative; }
        
        .letter-details-box { background: #f8fafc; border-left: 3px solid var(--theme-color); padding: 15px 20px; margin-bottom: 30px; font-family: 'Inter', sans-serif; font-size: 10px; }
        .detail-row { display: flex; margin-bottom: 6px; }
        .detail-row:last-child { margin-bottom: 0; }
        .detail-label { width: 100px; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 9px; }
        .detail-value { font-weight: 600; color: #1e293b; }
        
        .letter-sign-off { margin-top: auto; padding-top: 30px; }
        .signature { font-family: 'Great Vibes', cursive; font-size: 24px; color: var(--theme-color); margin: 10px 0; transform: rotate(-2deg); display: inline-block; }
        .dean-name { font-weight: 700; font-size: 11px; text-transform: uppercase; }
        .dean-title { font-size: 10px; color: #64748b; font-style: italic; }

        /* === 4. CERTIFICATE STYLES === */
        .certificate-container {
            width: 600px;
            height: 420px;
            background: #fff;
            padding: 40px;
            position: relative;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #1e293b;
            border: 12px solid #fff;
            outline: 5px double var(--theme-color);
            outline-offset: -18px;
            font-family: 'Merriweather', serif;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .cert-bg-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.04; width: 300px; height: 300px; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .cert-bg-logo img { width: 100%; height: 100%; object-fit: contain; }
        
        .cert-header-small { font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 3px; font-size: 10px; color: #64748b; margin-bottom: 15px; margin-top: 10px; }
        .cert-title { font-family: 'Great Vibes', cursive; font-size: 48px; color: var(--theme-color); margin-bottom: 20px; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cert-body { margin: 15px 0 25px 0; font-size: 12px; line-height: 2; max-width: 85%; position: relative; z-index: 10; }
        .cert-name { font-size: 26px; font-weight: 700; color: #0f172a; margin: 10px 0; font-family: 'Inter', sans-serif; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; display: inline-block; padding: 0 30px 5px 30px; letter-spacing: 1px; }
        
        .cert-footer { display: flex; justify-content: space-between; width: 100%; margin-top: auto; padding-top: 20px; position: relative; align-items: flex-end; }
        
        .cert-seal-box { position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; }
        .cert-seal { width: 100%; height: 100%; background: linear-gradient(135deg, var(--theme-color), var(--theme-color-light)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.9); font-size: 32px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid #fff; outline: 3px solid rgba(0,0,0,0.05); }
        .cert-seal-ribbon { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 40px; height: 20px; background: var(--theme-color); clip-path: polygon(0 0, 100% 0, 50% 100%); z-index: -1; }
        
        .cert-sign-block { text-align: center; width: 180px; }
        .cert-sign-line { border-bottom: 1px solid #cbd5e1; margin-bottom: 5px; height: 30px; display: flex; align-items: flex-end; justify-content: center; }
        .cert-sign-img { font-family: 'Great Vibes', cursive; font-size: 20px; color: var(--theme-color); transform: rotate(-3deg); }
        .cert-sign-label { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #64748b; font-family: 'Inter', sans-serif; }


        @media screen and (max-width: 600px) {
            .id-card { transform: scale(0.9); transform-origin: top center; }
            .letter-container { width: 100%; padding: 20px; transform: scale(0.9); transform-origin: top center; }
            .receipt { transform: scale(0.9); transform-origin: top center; }
            .certificate-container { width: 100%; height: auto; aspect-ratio: 1.4/1; transform: scale(0.9); transform-origin: top center; padding: 20px; }
            .cert-title { font-size: 32px; }
            .cert-name { font-size: 18px; }
        }

        /* === PRINT STYLES === */
        @media print {
            .controls-wrapper, .view-selector-container, .btn, .btn-download {
                display: none !important;
            }
            .preview-column {
                padding-top: 0;
            }
            .preview-item {
                display: flex !important;
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
                break-inside: avoid;
                page-break-after: always;
                border-bottom: none;
            }
            body {
                background: white;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <!-- === CONTROLS === -->
        <div class="controls-wrapper">
            <div class="controls-card">
                <h2><i class="fa-solid fa-sliders"></i> Identity Configuration</h2>
                
                <div class="form-section-title">University Settings</div>
                
                <!-- NEW: Preset Selector -->
                <div class="form-group">
                    <label>Select University</label>
                    <select class="form-control" id="selectUniPreset" style="background-color: #f0f9ff; border-color: #bae6fd; color: #0369a1; font-weight: 600;">
                        <option value="bsu">Bath Spa University</option>
                        <option value="pcc">Pasadena City College</option>
                        <option value="custom">Custom (Edit Below)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>University Name</label>
                    <input type="text" class="form-control" id="inputUniName" value="Bath Spa University">
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Subtitle</label>
                        <input type="text" class="form-control" id="inputUniSub" value="Established 1852">
                    </div>
                    <div class="form-group" style="flex: 0 0 60px;">
                        <label>Theme</label>
                        <input type="color" class="form-control" id="inputColor" value="#1e3a8a" style="padding: 2px; height: 38px;">
                    </div>
                </div>
                <div class="file-input-wrapper">
                    <label for="inputLogo">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Upload University Logo
                    </label>
                    <input type="file" id="inputLogo" accept="image/*">
                </div>

                <div class="form-section-title">Student Details</div>
                <div class="form-group">
                    <label>Full Name</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" class="form-control" id="inputName" placeholder="Generating...">
                        <button class="btn btn-secondary" id="btnRandomIdentity" style="width: auto; padding: 0 10px; margin: 0; background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;" title="Random Name & Photo">
                            <i class="fa-solid fa-shuffle"></i>
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Student ID</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" class="form-control" id="inputId" placeholder="Generating..." maxlength="12">
                            <button class="btn btn-secondary" id="btnRandomId" style="width: auto; padding: 0 10px; margin: 0;" title="Generate Random"><i class="fa-solid fa-dice"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Valid Thru</label>
                        <input type="text" class="form-control" id="inputDate" value="DEC 2026">
                    </div>
                </div>

                <div class="form-group">
                    <label>Role / Department</label>
                    <select class="form-control" id="inputRole">
                        <option value="Undergraduate Student">Undergraduate Student</option>
                        <option value="Graduate Student">Graduate Student</option>
                        <option value="Faculty Member">Faculty Member</option>
                        <option value="Staff / Administration">Staff / Administration</option>
                        <option value="Research Fellow">Research Fellow</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Current Status</label>
                    <select class="form-control" id="inputStatus">
                        <option value="Currently Enrolled">Currently Enrolled</option>
                        <option value="Active Student" selected>Active Student</option>
                        <option value="Academic Year 2">Academic Year 2</option>
                    </select>
                </div>

                <!-- NEW: Photo Generation Section -->
                <div class="form-section-title">Student Photo</div>
                
                <div class="file-input-wrapper">
                    <label for="inputPhoto">
                        <i class="fa-solid fa-camera"></i> Upload Photo (File)
                    </label>
                    <input type="file" id="inputPhoto" accept="image/*">
                </div>

                <div class="ai-options">
                    <div class="form-group" style="margin-bottom: 5px;">
                        <label>OR Generate with AI</label>
                        <select class="form-control" id="inputGender">
                            <option value="Female">Female Student</option>
                            <option value="Male">Male Student</option>
                        </select>
                    </div>
                    <button class="btn btn-generate" id="btnGeneratePhoto">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Passport Photo
                    </button>
                    <div id="genStatus" style="font-size: 10px; color: #64748b; margin-top: 5px; text-align: center;"></div>
                </div>

                <!-- New Download Button for Photo -->
                <button class="btn btn-secondary" id="btnDownloadPhoto" style="display: none; margin-bottom: 20px;">
                    <i class="fa-solid fa-download"></i> Download Student Photo
                </button>


                <!-- NEW SECTION -->
                <div class="form-section-title">Document Settings</div>
                <div class="form-group">
                    <label>Signatory Name</label>
                    <input type="text" class="form-control" id="inputSignatory" value="Eleanor V. Stone, Ph.D.">
                </div>
                <div class="form-group">
                    <label>Signatory Title</label>
                    <input type="text" class="form-control" id="inputSignatoryTitle" value="Dean of Admissions & Records">
                </div>

                <div class="form-section-title">Global Actions</div>
                <button class="btn btn-secondary" id="btnPrintAll" onclick="window.print()">
                    <i class="fa-solid fa-print"></i> Print All Documents
                </button>

            </div>
        </div>

        <!-- === PREVIEW AREA === -->
        <div class="preview-column">

            <!-- Dropdown Selector -->
            <div class="view-selector-container">
                <label style="font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block;">Select Document to View</label>
                <select id="viewSelector" class="form-control" style="font-weight: 600; border: 2px solid #cbd5e1; padding: 12px; height: auto;">
                    <option value="view-card">Student ID Card</option>
                    <option value="view-receipt">Payment Receipt</option>
                    <option value="view-letter">Admission Letter</option>
                    <option value="view-cert">Enrollment Certificate</option>
                </select>
            </div>
            
            <!-- 1. ID CARD -->
            <div class="preview-item" id="view-card">
                <div class="preview-header"><i class="fa-solid fa-id-card"></i> Student ID Card</div>
                <div class="id-card-wrapper" id="captureArea">
                    <div class="id-card">
                        <!-- Background Elements -->
                        <div class="security-pattern"></div>
                        <div class="gloss-overlay"></div>
                        <div class="header-bg"></div>
                        
                        <!-- Content -->
                        <div class="card-content">
                            <!-- Left Col: Photo -->
                            <div class="photo-section">
                                <div class="photo-frame">
                                    <div class="photo-placeholder" id="photoPlaceholder" style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #e2e8f0; color: #94a3b8;">
                                        <!-- No Icon -->
                                    </div>
                                    <img src="" alt="Student Photo" id="displayPhoto" style="display: none;">
                                </div>
                                <div class="student-role" id="displayRoleBadge">STUDENT</div>
                            </div>

                            <!-- Right Col: Details -->
                            <div class="details-section">
                                <div class="header-row">
                                    <!-- Swapped Order: Text First, then Logo -->
                                    <div class="university-text">
                                        <div class="university-name" id="displayUniName">Bath Spa University</div>
                                        <div class="university-sub" id="displayUniSub">Established 1852</div>
                                    </div>
                                    <div class="logo-slot">
                                        <!-- Removed Icon Placeholder -->
                                        <!-- PCC Placeholder Logo Text -->
                                        <div id="defaultLogoText" style="font-weight: 900; color: #1e3a8a; font-size: 16px;">BSU</div>
                                        <img src="" alt="Logo" id="displayLogo" style="display: none;">
                                    </div>
                                </div>

                                <div class="smart-chip">
                                    <div class="chip-lines"></div>
                                    <div class="chip-inner"></div>
                                </div>
                                <i class="fa-solid fa-wifi contactless"></i>

                                <div class="info-group">
                                    <div class="label">Name</div>
                                    <div class="value-large" id="displayName">Alex Richardson</div>
                                </div>

                                <div class="row" style="margin-top: 5px;">
                                    <div class="info-group">
                                        <div class="label">Valid Thru</div>
                                        <div class="value" id="displayDate">DEC 2026</div>
                                    </div>
                                    <div class="info-group" style="margin-left: 15px;">
                                        <div class="label">Status</div>
                                        <div class="value" id="displayStatus" style="color: #16a34a;">Active Student</div>
                                    </div>
                                </div>

                                <div class="id-number-group">
                                    <div class="label">ID Number</div>
                                    <div class="id-number" id="displayId">90882104</div>
                                </div>

                                <div class="hologram"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-download btn-sm" id="btnDownloadCard" onclick="downloadSection('captureArea', 'Student_ID')">
                    <i class="fa-solid fa-download"></i> Download PNG
                </button>
            </div>

            <!-- 2. RECEIPT -->
            <div class="preview-item" id="view-receipt">
                <div class="preview-header"><i class="fa-solid fa-receipt"></i> Payment Receipt</div>
                <div class="receipt" id="receiptArea">
                    <div class="paid-stamp">PAID</div>
                    <div class="receipt-header-section">
                        <div class="receipt-logo">
                            <!-- Removed Icon Placeholder -->
                            <img src="" alt="Logo" id="displayReceiptLogo" style="display: none;">
                        </div>
                        <div class="r-title" id="displayReceiptUni">Bath Spa University</div>
                        <div class="r-subtitle">Bursar's Office / Student Accounts</div>
                    </div>
                    
                    <div class="receipt-body">
                        <div class="r-row meta">
                            <span>DATE: <span id="receiptDate"></span></span>
                            <span>TERM: FALL 2025</span>
                        </div>
                        
                        <div class="r-row strong">
                            <span>STUDENT:</span>
                            <span id="displayReceiptName">ALEX RICHARDSON</span>
                        </div>
                        <div class="r-row">
                            <span>ID #:</span>
                            <span id="displayReceiptId">90882104</span>
                        </div>

                        <div class="r-divider"></div>

                        <table class="r-table">
                            <tr>
                                <td class="item">Tuition Fee (Sem 1)</td>
                                <td class="amt">$4,500.00</td>
                            </tr>
                            <tr>
                                <td class="item">Campus Facility Fee</td>
                                <td class="amt">$250.00</td>
                            </tr>
                            <tr>
                                <td class="item">ID Card Generation</td>
                                <td class="amt">$25.00</td>
                            </tr>
                            <tr>
                                <td class="item">Technology Access</td>
                                <td class="amt">$120.00</td>
                            </tr>
                        </table>

                        <div class="r-total">
                            <div class="r-total-row">
                                <span>TOTAL PAID</span>
                                <span>$4,895.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <div class="barcode-box">
                            <i class="fa-solid fa-barcode" style="font-size: 32px; transform: scaleX(1.5);"></i>
                        </div>
                        <div style="font-size: 9px; color: #94a3b8;">Auth: 882910-X • Term 21</div>
                    </div>
                </div>
                <button class="btn btn-download btn-sm" onclick="downloadSection('receiptArea', 'Receipt')">
                    <i class="fa-solid fa-download"></i> Download PNG
                </button>
            </div>

            <!-- 3. LETTER -->
            <div class="preview-item" id="view-letter">
                <div class="preview-header"><i class="fa-solid fa-envelope-open-text"></i> Admission Letter</div>
                <div class="letter-container" id="letterArea">
                    <div class="letter-watermark">
                        <i class="fa-solid fa-building-columns"></i>
                    </div>
                    
                    <div class="letter-head">
                        <div class="letter-logo">
                            <!-- Removed Icon Placeholder -->
                            <img src="" alt="Logo" id="displayLetterLogo" style="display: none;">
                        </div>
                        <div class="letter-uni-info">
                            <h1 id="displayLetterUni">Bath Spa University</h1>
                            <p>Office of the Registrar • Admissions Department</p>
                        </div>
                    </div>

                    <div class="letter-meta">
                        <span id="letterDate">October 24, 2025</span>
                    </div>

                    <div class="letter-recipient">
                        <div style="margin-bottom: 2px;"><strong><span id="displayLetterName">ALEX RICHARDSON</span></strong></div>
                        <div style="margin-bottom: 2px;">Student ID: <span id="displayLetterId" style="font-family: 'Share Tech Mono', monospace; font-size: 12px; letter-spacing: 0.5px;">90882104</span></div>
                        <div id="displayLetterAddr"></div>
                    </div>

                    <div class="letter-body">
                        <p><strong>RE: OFFICIAL OFFER OF ADMISSION AND ENROLLMENT CONFIRMATION</strong></p>
                        <p>&nbsp;</p>
                        <p>Dear <span id="displayLetterSalutation">Alex Richardson</span>,</p>
                        <p>It is my distinct pleasure to formally confirm your admission and active enrollment at <span id="displayLetterUniBody">Bath Spa University</span> for the 2025-2026 academic year. The Admissions Committee has reviewed your academic credentials and verified that you have met all necessary requirements for entry into the university.</p>
                        <p>This letter serves as official documentation of your status as a registered student. You are now a member of a vibrant academic community dedicated to excellence, innovation, and integrity. We are confident that you will find your time here intellectually stimulating and personally rewarding.</p>
                        <p>Enclosed within this package, please find your official Student Identification Card and the receipt for your tuition and fees. Your ID card is essential for accessing campus facilities, including the library, laboratories, and student centers. Please ensure you carry it with you at all times while on university premises.</p>
                    </div>

                    <div class="letter-details-box">
                        <div class="detail-row">
                            <div class="detail-label">Current Status:</div>
                            <div class="detail-value">Enrolled / Active</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Program Role:</div>
                            <div class="detail-value" id="displayLetterRole">Undergraduate Student</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Card Validity:</div>
                            <div class="detail-value" id="displayLetterDate">DEC 2026</div>
                        </div>
                    </div>

                    <div class="letter-body">
                        <p>We look forward to welcoming you to campus. Should you have any questions regarding your schedule, orientation, or academic requirements, please do not hesitate to contact the Office of the Registrar.</p>
                        <p>Congratulations on your acceptance.</p>
                    </div>

                    <div class="letter-sign-off">
                        <p>Sincerely,</p>
                        <div class="signature" id="displayLetterSign">Eleanor V. Stone</div>
                        <div class="dean-name" id="displayLetterSignName">Eleanor V. Stone, Ph.D.</div>
                        <div class="dean-title" id="displayLetterSignTitle">Dean of Admissions & Records</div>
                    </div>
                </div>
                <button class="btn btn-download btn-sm" onclick="downloadSection('letterArea', 'Admission_Letter')">
                    <i class="fa-solid fa-download"></i> Download PNG
                </button>
            </div>

            <!-- 4. OFFICIAL CERTIFICATE (NEW) -->
            <div class="preview-item" id="view-cert">
                <div class="preview-header"><i class="fa-solid fa-certificate"></i> Enrollment Certificate</div>
                <div class="certificate-container" id="certArea">
                    <div class="cert-bg-logo">
                        <!-- Removed Icon Placeholder -->
                        <img src="" alt="Logo" id="certBgImg" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                    </div>
                    
                    <div class="cert-header-small" id="displayCertUni">Bath Spa University</div>
                    <div class="cert-title">Certificate of Enrollment</div>
                    
                    <div class="cert-body">
                        <p>THIS DOCUMENT CERTIFIES THAT</p>
                        <div class="cert-name" id="displayCertName">Alex Richardson</div>
                        <p>IS OFFICIALLY REGISTERED AS A STUDENT FOR THE CURRENT ACADEMIC YEAR.</p>
                        <p>ID NUMBER: <span id="displayCertId" style="font-family: 'Share Tech Mono'; font-weight: bold;">90882104</span></p>
                        <p>VALID THROUGH: <span id="displayCertDate" style="font-weight: bold;">DEC 2026</span></p>
                    </div>
                    
                    <div class="cert-footer">
                        <div class="cert-sign-block">
                            <div class="cert-sign-line">
                                <span class="cert-sign-img" id="displayCertSign">Eleanor V. Stone</span>
                            </div>
                            <div class="cert-sign-label" id="displayCertSignTitle">Dean of Admissions & Records</div>
                        </div>
                        
                        <div class="cert-seal-box">
                            <div class="cert-seal">
                                <i class="fa-solid fa-building-columns"></i>
                            </div>
                            <div class="cert-seal-ribbon"></div>
                        </div>
                        
                        <div class="cert-sign-block">
                             <div class="cert-sign-line">
                                <span class="cert-sign-img" style="font-size: 16px; color: #1e293b;">Oct 24, 2025</span>
                            </div>
                            <div class="cert-sign-label">Date of Issue</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-download btn-sm" onclick="downloadSection('certArea', 'Certificate')">
                    <i class="fa-solid fa-download"></i> Download PNG
                </button>
            </div>

        </div>
    </div>

    <script>
        // API Key for Image Generation (Injected by Environment)
        const apiKey = ""; 

        // University Presets Data (Manual Mode: No logo URLs)
        const uniPresets = {
            bsu: {
                name: "Bath Spa University",
                sub: "Established 1852",
                abbr: "BSU"
            },
            pcc: {
                name: "Pasadena City College",
                sub: "Established 1924",
                abbr: "PCC"
            }
        };

        // Data for Random Generation (Expanded List)
        const maleNames = [
            "James", "John", "Robert", "Michael", "William", "David", "Richard", "Joseph", "Thomas", "Charles", 
            "Christopher", "Daniel", "Matthew", "Anthony", "Mark", "Donald", "Steven", "Paul", "Andrew", "Joshua", 
            "Kenneth", "Kevin", "Brian", "George", "Edward", "Ronald", "Timothy", "Jason", "Jeffrey", "Ryan", 
            "Jacob", "Gary", "Nicholas", "Eric", "Jonathan", "Stephen", "Larry", "Justin", "Scott", "Brandon", 
            "Benjamin", "Samuel", "Gregory", "Frank", "Alexander", "Raymond", "Patrick", "Jack", "Dennis", "Jerry", 
            "Tyler", "Aaron", "Jose", "Adam", "Nathan", "Henry", "Douglas", "Zachary", "Peter", "Kyle", 
            "Walter", "Ethan", "Jeremy", "Harold", "Keith", "Christian", "Roger", "Noah", "Gerald", "Terry", 
            "Sean", "Austin", "Carl", "Arthur", "Lawrence", "Dylan", "Jesse", "Jordan", "Bryan", "Billy", 
            "Joe", "Bruce", "Gabriel", "Logan", "Albert", "Willie", "Alan", "Juan", "Wayne", "Roy", 
            "Ralph", "Randy", "Eugene", "Vincent", "Russell", "Louis", "Philip", "Bobby", "Johnny", "Bradley",
            "Caleb", "Liam", "Mason", "Hunter", "Connor", "Elijah", "Caden", "Marlon", "Jasper", "Silas", 
            "Felix", "Oliver", "Harry", "Jack", "Charlie", "Alfie", "Jacob", "Oscar", "George", "Leo", 
            "Muhammad", "Archie", "Noah", "Henry", "Thomas", "Joshua", "William", "James", "Ethan", "Lucas",
            "Aiden", "Jackson", "Logan", "Sebastian", "Julian", "Mateo", "Levi", "Wyatt", "Owen", "Luke"
        ];
        
        const femaleNames = [
            "Mary", "Patricia", "Jennifer", "Linda", "Elizabeth", "Barbara", "Susan", "Jessica", "Sarah", "Karen", 
            "Nancy", "Lisa", "Betty", "Margaret", "Sandra", "Ashley", "Kimberly", "Emily", "Donna", "Michelle", 
            "Dorothy", "Carol", "Amanda", "Melissa", "Deborah", "Stephanie", "Rebecca", "Sharon", "Laura", "Cynthia", 
            "Kathleen", "Amy", "Shirley", "Angela", "Helen", "Anna", "Brenda", "Pamela", "Nicole", "Emma", 
            "Samantha", "Katherine", "Christine", "Debra", "Rachel", "Catherine", "Carolyn", "Janet", "Ruth", "Maria", 
            "Heather", "Diane", "Virginia", "Julie", "Joyce", "Victoria", "Olivia", "Kelly", "Christina", "Lauren", 
            "Joan", "Evelyn", "Judith", "Megan", "Cheryl", "Andrea", "Hannah", "Martha", "Jacqueline", "Frances", 
            "Gloria", "Ann", "Teresa", "Kathryn", "Sara", "Janice", "Jean", "Alice", "Madison", "Doris", 
            "Julia", "Judy", "Grace", "Denise", "Amber", "Marilyn", "Beverly", "Danielle", "Theresa", "Sophia", 
            "Marie", "Diana", "Brittany", "Natalie", "Isabella", "Charlotte", "Rose", "Alexis", "Kayla",
            "Ava", "Mia", "Amelia", "Harper", "Evelyn", "Abigail", "Emily", "Ella", "Elizabeth", "Camila",
            "Luna", "Sofia", "Avery", "Mila", "Aria", "Scarlett", "Penelope", "Layla", "Chloe", "Victoria",
            "Madison", "Eleanor", "Grace", "Nora", "Riley", "Zoey", "Hannah", "Hazel", "Lily", "Ellie"
        ];
        
        const lastNames = [
            "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", 
            "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin", 
            "Lee", "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson", 
            "Walker", "Young", "Allen", "King", "Wright", "Scott", "Torres", "Nguyen", "Hill", "Flores", 
            "Green", "Adams", "Nelson", "Baker", "Hall", "Rivera", "Campbell", "Mitchell", "Carter", "Roberts", 
            "Gomez", "Phillips", "Evans", "Turner", "Diaz", "Parker", "Cruz", "Edwards", "Collins", "Reyes", 
            "Stewart", "Morris", "Morales", "Murphy", "Cook", "Rogers", "Gutierrez", "Ortiz", "Morgan", "Cooper", 
            "Peterson", "Bailey", "Reed", "Kelly", "Howard", "Ramos", "Kim", "Cox", "Ward", "Richardson", 
            "Watson", "Brooks", "Chavez", "Wood", "James", "Bennett", "Gray", "Mendoza", "Ruiz", "Hughes", 
            "Price", "Alvarez", "Castillo", "Sanders", "Patel", "Myers", "Long", "Ross", "Foster", "Jimenez",
            "Powell", "Jenkins", "Perry", "Russell", "Sullivan", "Wallace", "Woods", "Cole", "West", "Jordan",
            "Owens", "Reynolds", "Fisher", "Ellis", "Harrison", "Gibson", "McDonald", "Cruz", "Marshall", "Ortiz",
            "Gomez", "Murray", "Freeman", "Wells", "Webb", "Simpson", "Stevens", "Tucker", "Porter", "Hunter"
        ];

        // Global download function
        function downloadSection(elementId, filenamePrefix) {
            const element = document.getElementById(elementId);
            const btn = event.currentTarget; 
            const originalText = btn.innerHTML;
            const studentId = document.getElementById('inputId').value || '0000';
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            
            const parentItem = element.closest('.preview-item');
            if (parentItem) {
                parentItem.style.animation = 'none';
                parentItem.style.transform = 'none'; 
            }

            setTimeout(() => {
                html2canvas(element, {
                    scale: 3, 
                    backgroundColor: null,
                    logging: false,
                    useCORS: true,
                    // REMOVED allowTaint: true because it blocks secure export of images
                    onclone: (clonedDoc) => {
                        const clonedEl = clonedDoc.getElementById(elementId);
                        if (clonedEl) {
                            clonedEl.style.display = 'flex'; 
                            if (elementId === 'captureArea') {
                                const card = clonedEl.querySelector('.id-card');
                                if (card) card.style.transform = 'none';
                            }
                        }
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${filenamePrefix}_${studentId}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    btn.innerHTML = originalText;
                    if (parentItem) parentItem.style.animation = ''; 
                }).catch(err => {
                    console.error("HTML2Canvas Error:", err);
                    btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Error';
                    setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                    if (parentItem) parentItem.style.animation = ''; 
                });
            }, 100);
        }

        async function generateAIPhoto() {
            const btn = document.getElementById('btnGeneratePhoto');
            const status = document.getElementById('genStatus');
            const gender = document.getElementById('inputGender').value;
            const originalText = btn.innerHTML;
            const downloadBtn = document.getElementById('btnDownloadPhoto');

            if (!apiKey) {
                status.textContent = "AI generation unavailable (Key missing)";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
            status.textContent = "Calling AI model (approx. 5-10s)...";
            status.style.color = "#64748b"; // Reset color

            const prompt = `passport photo of a ${gender} university student, facing camera, neutral expression, white background, high quality, realistic`;

            try {
                // Updated to imagen-4.0-generate-001 as per environment requirements
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Changed instances to array to be safe, though instructions were ambiguous
                    body: JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: { sampleCount: 1 }
                    })
                });

                if (!response.ok) {
                    let errorMsg = `API Error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg += ` - ${errorData.error.message}`;
                        }
                    } catch (e) {
                        // ignore parsing error
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                const base64Image = data.predictions?.[0]?.bytesBase64Encoded;

                if (base64Image) {
                    const dataUrl = `data:image/png;base64,${base64Image}`;
                    
                    // Update display
                    const displayPhoto = document.getElementById('displayPhoto');
                    const placeholder = document.getElementById('photoPlaceholder');
                    
                    displayPhoto.src = dataUrl;
                    displayPhoto.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    
                    if (downloadBtn) downloadBtn.style.display = 'flex'; // Show download button

                    status.textContent = "Photo generated successfully!";
                    status.style.color = "green";
                } else {
                    throw new Error("No image data received");
                }

            } catch (error) {
                console.error(error);
                status.textContent = "Generation failed. Please try again.";
                status.style.color = "red";
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Functions for Random Data Generation
        function generateRandomIdentity(triggerPhoto = false) {
            const isMale = Math.random() > 0.5;
            const gender = isMale ? 'Male' : 'Female';
            const firstNames = isMale ? maleNames : femaleNames;
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const fullName = `${firstName} ${lastName}`;

            // Update Name Input
            const nameInput = document.getElementById('inputName');
            nameInput.value = fullName;
            nameInput.dispatchEvent(new Event('input'));

            // Update Gender Select
            const genderSelect = document.getElementById('inputGender');
            if (genderSelect) {
                genderSelect.value = gender;
            }

            if (triggerPhoto) {
                generateAIPhoto();
            }
        }

        function generateRandomId() {
            const randomId = Math.floor(10000000 + Math.random() * 90000000);
            const idInput = document.getElementById('inputId');
            idInput.value = randomId;
            idInput.dispatchEvent(new Event('input'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Setup Generate Button
            const genBtn = document.getElementById('btnGeneratePhoto');
            if (genBtn) {
                genBtn.addEventListener('click', generateAIPhoto);
            }

            // View Selector Logic
            const selector = document.getElementById('viewSelector');
            const views = ['view-card', 'view-receipt', 'view-letter', 'view-cert'];
            
            selector.addEventListener('change', (e) => {
                const selected = e.target.value;
                views.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === selected) {
                            el.classList.add('active');
                        } else {
                            el.classList.remove('active');
                        }
                    }
                });
            });

            // Initialize view
            selector.dispatchEvent(new Event('change'));

            // State references
            const elements = {
                uniPreset: document.getElementById('selectUniPreset'),
                uniName: document.getElementById('inputUniName'),
                uniSub: document.getElementById('inputUniSub'),
                color: document.getElementById('inputColor'),
                name: document.getElementById('inputName'),
                id: document.getElementById('inputId'),
                role: document.getElementById('inputRole'),
                status: document.getElementById('inputStatus'),
                date: document.getElementById('inputDate'),
                photo: document.getElementById('inputPhoto'),
                logo: document.getElementById('inputLogo'),
                signatory: document.getElementById('inputSignatory'),
                signTitle: document.getElementById('inputSignatoryTitle'),
                btnRandom: document.getElementById('btnRandomId'),
                btnRandomIdentity: document.getElementById('btnRandomIdentity'),
            };

            const displays = {
                uniName: [
                    document.getElementById('displayUniName'), 
                    document.getElementById('displayReceiptUni'), 
                    document.getElementById('displayLetterUni'), 
                    document.getElementById('displayCertUni'),
                    document.getElementById('displayLetterUniBody') // Added body text to update list
                ],
                uniSub: document.getElementById('displayUniSub'),
                name: [document.getElementById('displayName'), document.getElementById('displayReceiptName'), document.getElementById('displayLetterName'), document.getElementById('displayCertName')],
                id: [document.getElementById('displayId'), document.getElementById('displayReceiptId'), document.getElementById('displayLetterId'), document.getElementById('displayCertId')],
                role: document.getElementById('displayRoleBadge'),
                status: document.getElementById('displayStatus'),
                letterRole: document.getElementById('displayLetterRole'),
                date: [document.getElementById('displayDate'), document.getElementById('displayLetterDate'), document.getElementById('displayCertDate')],
                photoImg: document.getElementById('displayPhoto'),
                photoPlaceholder: document.getElementById('photoPlaceholder'),
                logoImgs: [document.getElementById('displayLogo'), document.getElementById('displayReceiptLogo'), document.getElementById('displayLetterLogo')],
                logoPlaceholders: [document.getElementById('logoPlaceholder'), document.getElementById('receiptLogoPlaceholder'), document.getElementById('letterLogoPlaceholder')],
                signatoryName: [document.getElementById('displayLetterSignName')],
                signatorySig: [document.getElementById('displayLetterSign'), document.getElementById('displayCertSign')],
                signatoryTitle: [document.getElementById('displayLetterSignTitle'), document.getElementById('displayCertSignTitle')]
            };

            // Set current dates
            const today = new Date();
            
            // Receipt Date = Today
            document.getElementById('receiptDate').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'numeric', day: 'numeric' });
            
            // Letter Date = 2 Days Ago
            const letterDateObj = new Date(today);
            letterDateObj.setDate(today.getDate() - 2);
            const letterDateStr = letterDateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('letterDate').textContent = letterDateStr;

            // --- Event Listeners ---

            // Generate Random Data on Load
            generateRandomIdentity(false); // Generate name/gender, but NOT photo
            generateRandomId();

            // University Preset Switcher
            elements.uniPreset.addEventListener('change', (e) => {
                const key = e.target.value;
                if (key !== 'custom' && uniPresets[key]) {
                    const data = uniPresets[key];
                    elements.uniName.value = data.name;
                    elements.uniSub.value = data.sub;
                    
                    // Update hidden logo text in case no image is uploaded
                    const defaultText = document.getElementById('defaultLogoText');
                    if (defaultText) defaultText.textContent = data.abbr;

                    // Trigger input events to update previews
                    elements.uniName.dispatchEvent(new Event('input'));
                    elements.uniSub.dispatchEvent(new Event('input'));
                }
            });

            // Text Inputs
            elements.uniName.addEventListener('input', (e) => {
                displays.uniName.forEach(el => { if(el) el.textContent = e.target.value || 'University'; });
                
                // If user types manually, set preset to custom
                if (e.isTrusted && elements.uniPreset.value !== 'custom') { 
                     elements.uniPreset.value = 'custom';
                }
            });
            
            elements.uniSub.addEventListener('input', (e) => {
                displays.uniSub.textContent = e.target.value;
            });

            elements.name.addEventListener('input', (e) => {
                const val = e.target.value || 'Student Name';
                // Uppercase for ID/Receipt/Cert
                displays.name.forEach(el => { if(el) el.textContent = val.toUpperCase(); });
                
                // Mixed Case for Letter Salutation
                const salutation = document.getElementById('displayLetterSalutation');
                if(salutation) salutation.textContent = val;
            });

            elements.id.addEventListener('input', (e) => {
                const val = e.target.value || '00000000';
                displays.id.forEach(el => el.textContent = val);
            });

            elements.date.addEventListener('input', (e) => {
                const val = e.target.value || 'DEC 2026';
                displays.date.forEach(el => el.textContent = val);
            });
            
            // New Signatory Inputs
            elements.signatory.addEventListener('input', (e) => {
                const val = e.target.value || 'Signatory Name';
                // Update Printed Name
                displays.signatoryName.forEach(el => el.textContent = val);
                // Update Cursive Signature (strip titles for signature maybe? keeping as is for flexibility)
                const sigVal = val.split(',')[0]; // Simple logic to take first part for signature
                displays.signatorySig.forEach(el => el.textContent = sigVal);
            });
            
            elements.signTitle.addEventListener('input', (e) => {
                const val = e.target.value || 'Title';
                displays.signatoryTitle.forEach(el => el.textContent = val);
            });

            elements.role.addEventListener('change', (e) => {
                let role = e.target.value;
                let badgeText = "STUDENT";
                
                if (role.includes("Faculty")) badgeText = "FACULTY";
                else if (role.includes("Staff")) badgeText = "STAFF";
                else if (role.includes("Fellow")) badgeText = "RESEARCH";
                
                displays.role.textContent = badgeText;
                displays.letterRole.textContent = role;
            });

            elements.status.addEventListener('change', (e) => {
                const val = e.target.value;
                displays.status.textContent = val;
                
                // Change color based on status
                if (val === 'Active Student') {
                    displays.status.style.color = '#16a34a'; // Green
                } else {
                    displays.status.style.color = '#0f172a'; // Default Dark
                }
            });

            // Color Theme
            elements.color.addEventListener('input', (e) => {
                const hex = e.target.value;
                document.documentElement.style.setProperty('--theme-color', hex);
                // Calculate a lighter version for gradient
                const r = parseInt(hex.substring(1,3), 16);
                const g = parseInt(hex.substring(3,5), 16);
                const b = parseInt(hex.substring(5,7), 16);
                const lighter = `rgba(${r}, ${g}, ${b}, 0.85)`; 
                document.documentElement.style.setProperty('--theme-color-light', lighter);
            });

            // Image Handlers
            const handleImageUpload = (input, imgElements, isLogo) => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (Array.isArray(imgElements)) {
                            imgElements.forEach(img => {
                                img.src = e.target.result;
                                img.style.display = 'block';
                            });
                            if (isLogo) {
                                const defaultText = document.getElementById('defaultLogoText');
                                if(defaultText) defaultText.style.display = 'none';
                                
                                // Update Certificate Background
                                const certBgImg = document.getElementById('certBgImg');
                                if (certBgImg) {
                                    certBgImg.src = e.target.result;
                                    certBgImg.style.display = 'block';
                                }
                            }
                        } else {
                            imgElements.src = e.target.result;
                            imgElements.style.display = 'block';
                            const placeholder = document.getElementById('photoPlaceholder');
                            if (placeholder) placeholder.style.display = 'none';
                            
                            // If this is the student photo input, show download button
                            if (input.id === 'inputPhoto') {
                                const downloadBtn = document.getElementById('btnDownloadPhoto');
                                if (downloadBtn) downloadBtn.style.display = 'flex';
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };

            elements.photo.addEventListener('change', () => handleImageUpload(elements.photo, displays.photoImg));
            elements.logo.addEventListener('change', () => handleImageUpload(elements.logo, displays.logoImgs, true));

            // Download Photo Button Logic
            const btnDownloadPhoto = document.getElementById('btnDownloadPhoto');
            if (btnDownloadPhoto) {
                btnDownloadPhoto.addEventListener('click', () => {
                    const img = document.getElementById('displayPhoto');
                    const studentId = document.getElementById('inputId').value || '0000';
                    if (img && img.src) {
                        const link = document.createElement('a');
                        link.download = `Student_Photo_${studentId}.png`;
                        link.href = img.src;
                        link.click();
                    }
                });
            }

            // Random ID Generator
            elements.btnRandom.addEventListener('click', generateRandomId);

            // Random Identity Generator (Name + Auto Photo)
            if (elements.btnRandomIdentity) {
                elements.btnRandomIdentity.addEventListener('click', () => {
                    generateRandomIdentity(true); // Trigger photo generation on click
                });
            }
        });
    </script>
</body>
</html>